delimiter //
CREATE TRIGGER trigger_personne_telephone
BEFORE INSERT ON Personne
FOR EACH ROW
BEGIN
	IF NEW.telephone NOT like '__________' THEN
    	SIGNAL SQLSTATE VALUE '45005'
        SET MESSAGE_TEXT = 'Numero de telephone invalide';
    END IF;
END;
//

delimiter //
CREATE TRIGGER trigger_personne_mail
BEFORE INSERT ON Personne
FOR EACH ROW
BEGIN
	IF NEW.email NOT like '_%@_%.__%' THEN
    	SIGNAL SQLSTATE VALUE '45006'
        SET MESSAGE_TEXT = 'email invalide';
    END IF;
END;
//

delimiter //
CREATE TRIGGER trigger_absence_eleve_in_promotion
BEFORE INSERT ON Absence
FOR EACH ROW
BEGIN
	IF (select count(*) from cours, contenir where NEW.id_cours=cours.id_cours and cours.id_promotion=contenir.id_promotion and contenir.id_eleve=NEW.id_personne) = 0 THEN
    	SIGNAL SQLSTATE VALUE '45001'
        SET MESSAGE_TEXT = 'Eleve non present au cours';
    END IF;
END;
//
	
delimiter //
CREATE TRIGGER trigger_presentiel_eleve_in_promotion
BEFORE INSERT ON Presentiel
FOR EACH ROW
BEGIN
	IF (select count(*) from cours, contenir where NEW.id_cours=cours.id_cours and cours.id_promotion=contenir.id_promotion and contenir.id_eleve=NEW.id_personne) = 0 THEN
    	SIGNAL SQLSTATE VALUE '45001'
        SET MESSAGE_TEXT = 'Eleve non present au cours';
    END IF;
END;
//


delimiter //
CREATE TRIGGER trigger_etage_doublon_batiment
BEFORE INSERT ON Etage
FOR EACH ROW
BEGIN
	IF (select count(*) from Etage where id_batiment = NEW.id_batiment and num = NEW.num) > 0 THEN
    	SIGNAL SQLSTATE VALUE '45002'
        SET MESSAGE_TEXT = 'Etage existant pour ce batiment';
    END IF;
END;
//

delimiter //
CREATE TRIGGER trigger_promotion_annee_proche
BEFORE INSERT ON Promotion
FOR EACH ROW
BEGIN
	IF NEW.annee < (SELECT YEAR(NOW())-1) THEN
    	SIGNAL SQLSTATE VALUE '45003'
        SET MESSAGE_TEXT = 'Annee trop ancienne pour enregistrement';
	ELSEIF NEW.annee > (SELECT YEAR(NOW())+1) THEN
		SIGNAL SQLSTATE VALUE '45004'
        SET MESSAGE_TEXT = 'Quitte à voyager à travers le temps au volant d’une voiture, autant en choisir une qui ait de la gueule';
    END IF;
END;
//
